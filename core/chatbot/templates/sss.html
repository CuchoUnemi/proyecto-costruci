<script>
    document.addEventListener('DOMContentLoaded', () => {
        const sendButton = document.getElementById('send-button');
        const chatInput = document.getElementById('chat-input');
        const chatbox = document.getElementById('chatbox');
        let sessionId = null;  // Variable para almacenar el session_id
        newChatContainer.style.display = 'none'; // Ocultar el botón de nuevo chat
        sendButton.disabled = false; // Rehabilitar el botón de enviar
        chatInput.disabled = false; // Rehabilitar el input

        // Función para agregar un mensaje al chatbox
        function addMessageToChatbox(messageHtml) {
            chatbox.insertAdjacentHTML('beforeend', messageHtml);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Cargar mensajes guardados en localStorage (para usuarios invitados)
        if (localStorage.getItem('chatHistory')) {
            chatbox.innerHTML = localStorage.getItem('chatHistory');
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // Manejar el envío del mensaje
        sendButton.addEventListener('click', () => {
            sessionId = localStorage.getItem('sessionId') || null;
            console.log('rrrrrrrrrrrrrrrrrr');
            console.log(sessionId);
            console.log('rrrrrrrrrrrrrrrrrr');
            const message = chatInput.value.trim();
            if (message !== '') {
                // Mensaje del usuario
                const userMessage = `
                    <div class="flex justify-end mb-4">
                        <div class="text-sm text-white bg-orange-500 dark:bg-orange-400 p-2 rounded-lg">${message}</div>
                        <img src="{% static 'img/hero32.jpeg' %}" alt="Avatar de Usuario" class="w-6 h-6 rounded-full ml-2">
                    </div>
                `;
                addMessageToChatbox(userMessage);

                // Limpiar el input
                chatInput.value = '';

                // Mostrar indicador de "escribiendo..."
                const typingIndicator = `
                    <div id="typing-indicator" class="flex items-start mb-4">
                        <img src="{% static 'img/mmmmmmmmmmmmmmm.jpg' %}" alt="Avatar de UnemIA" class="w-6 h-6 rounded-full mr-2">
                        <div class="text-sm text-gray-500 dark:text-gray-400">UnemIA está escribiendo<span class="typing-dots">...</span></div>
                    </div>
                `;
                addMessageToChatbox(typingIndicator);

                // Enviar mensaje al chatbot
                fetch('{% url "ChatBot:chatbot_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        message: message,
                        new_session: sessionId == null,  // Si no hay sessionId, se crea una nueva sesión
                        session_id: sessionId  // Se envía el session_id existente
                    })
                })
                .then(response => {
                        // Eliminar el indicador de "escribiendo..."
                        document.getElementById('typing-indicator').remove();

                        if (response.status === 403) {
                            console.log("___________0estatus 403_______")
                            // Mostrar un mensaje de error si la sesión está inactiva
                            const errorMessage = `
                            <div class="flex items-start mb-4">
                                <div class="text-sm text-red-500">La sesión ha expirado o está inactiva. Verifica tu sessionId.</div>
                            </div>
                            `;
                            addMessageToChatbox(errorMessage);

                            // Limpiar el sessionId en localStorage
                            localStorage.removeItem('sessionId');
                            sessionId = null;  // Reiniciar la sesión

                            // Ocultar input y botón de enviar, mostrar botón de nuevo chat
                            chatInput.disabled = true;
                            sendButton.disabled = true;
                            newChatContainer.style.display = 'block'; // Mostrar botón de nuevo chat

                            return; // Salir para evitar que se ejecute el siguiente .then()
                        }
                        return response.json();

                })
                .then(data => {
                     if (data) {
                        // Guardar el session_id si se ha creado o continuado una sesión
                        if (data.session_id) {
                            sessionId = data.session_id;  // Actualizar el sessionId
                            localStorage.setItem('sessionId', sessionId);
                        }

                        // Respuesta del bot
                        const botMessage = `
                        <div class="flex items-start mb-4">
                            <img src="{% static 'img/mmmmmmmmmmmmmmm.jpg' %}" alt="Avatar de UnemIA" class="w-6 h-6 rounded-full mr-2">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${data.response}</div>
                        </div>
                        `;
                        addMessageToChatbox(botMessage);
                    }
                })
                .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('typing-indicator').remove();
                        const errorMessage = `
                        <div class="flex items-start mb-4">
                            <div class="text-sm text-gray-500 dark:text-gray-400">Lo siento, hubo un problema al procesar tu mensaje.</div>
                        </div>
                    `;
                        addMessageToChatbox(errorMessage);
                });
            }
        });

        // Manejar el evento 'Enter' en el campo de entrada
        chatInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendButton.click();
            }
        });
    });
</script>